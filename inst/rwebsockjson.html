<html>
<head>
<title>R/Websockets</title>
<link rel="stylesheet" href="style.css" type="text/css" />
<style type="text/css" media="screen">
.fright {
  float: right;
  margin: 0 0 10px 10px;
  clear: right;
}
</style>
<script type="text/javascript" src="flotr/flotr/lib/prototype-1.6.0.2.js"></script>
<script type="text/javascript" src="flotr/flotr/lib/canvas2image.js"></script>
<script type="text/javascript" src="flotr/flotr/lib/canvastext.js"></script>
<script type="text/javascript" src="flotr/flotr/flotr-0.2.0-alpha.js"></script>
</head>

<body>
<img class="fright" src="HTML5_Logo_64.png" alt="HTML5" width="64" height="64"/>
<h2>R/Websockets Simple Plotting Example with flotr and JSON</h2>
<div id="input">
  <br />
  <table><tr>
  <td>
  <input type="text" id="intext" value="11" size="20" maxlength="20"/>
  </td><td>
  <input type=button id="send" value="Submit" onclick="hello();"/>
  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
  </td>
  <td id="statustd">
  <div id="wsdi_status"> Connection not initialized </div>
  </td></tr></table>
</div>
<hr />
<div id="container" style="display:none;width:600px;height:300px;"></div>
<div id="blurb" style="width:85%">
Once connected, press the "Submit" button to request that your local
R engine generate some random numbers. They will be displayed in a
plot generated by flotr.
<p />
The 'rwebsockets' package is a simple and portable websockets implementation
for the R language, based on the C 'libwebsockets' library.
The rwebsockets package is especially well-suited to
lightweight Javascript/R integration.
<p />
Some versions of Firefox ship with Websockets disabled by default.
To enable them, see, for example, this link:
<a href="http://techdows.com/2010/12/turn-on-websockets-in-firefox-4.html">
http://techdows.com/2010/12/turn-on-websockets-in-firefox-4.html</a>
<p />
HTML 5 websockets is a modern lightweight socket-like communication protocol.
Although still in development, HTML 5 websockets is widely supported:
most recent browsers support it and
there are many high-quality langauge implementations.
HTML 5 websockets let Javascript and other scripts embedded within web
pages directly interact with R, bypassing traditional middleware layers
like .NET, Java, and other web services, normally used for such interaction.
<p />
Note that, although this web page was loaded from
<a href="http://illposed.net/rwebsockjson.html">http://illposed.net/rwebsockjson.html</a>,
the communication between Javascript and R is taking place entirely on the
local system through HTML 5 Websockets.
</div>

<script>
function get_appropriate_ws_url()
{
  return("ws://localhost:7681");
}


document.getElementById("wsdi_status").textContent = 
 "This example requires a local rwebsocket service on " + 
 get_appropriate_ws_url();

var socket = new WebSocket(get_appropriate_ws_url(), "R");
try {
  socket.onopen = function() {
    document.getElementById("wsdi_status").textContent =
     " websocket connection opened to  " + get_appropriate_ws_url();
    document.getElementById("statustd").style.backgroundColor = "#40ff40";
  } 
  socket.onmessage = function got_packet(msg) {
    var json = JSON.parse(msg.data);
    document.getElementById('container').setStyle({'display':'block'});
    f = Flotr.draw(document.getElementById('container'), json.series,
          json.options);
  } 
  socket.onclose = function(){
    document.getElementById("wsdi_status").textContent = " websocket connection CLOSED (example requires a local rwebsocket service) ";
    document.getElementById("statustd").style.backgroundColor = "#ff4040";
  }
} catch(exception) {
  alert('<p>Error' + exception);  
}

function hello() {
  socket.send(document.getElementById("intext").value);
}

</script>

</body>
</html>
